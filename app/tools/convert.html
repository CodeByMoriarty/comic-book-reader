<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline'"
    />
    <link href="../assets/fontawesome/css/all.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="../assets/libs/materialize/css/materialize.min.css"
    />
    <link rel="stylesheet" href="../assets/css/convert.css" />
    <title>Convert File Tool</title>
  </head>
  <body>
    <!-- <h5><i class="fas fa-tools"></i></h5> -->
    <div class="container center-align">
      <h5>Input File:</h5>
      <div class="card" id="input-list">
        <!-- <div class="card-content">
          /home/alvaro/test/home/alvaro/test/home/alvaro/test/home/alvaro/test/home/alvaro/test/file.cbr
        </div> -->
        <!-- <a class="waves-effect waves-light btn">DISCARD</a> -->
      </div>
      <!-- <a class="waves-effect waves-light btn" onclick="onChooseInputFile()"
          >ADD</a
        > -->

      <h5>
        Output Size (%):
        <i
          class="fas fa-question-circle tooltipped blue-text accent-1-text"
          data-position="bottom"
          data-tooltip="The size of the pages will be reduced to this percentage of the originals"
        ></i>
      </h5>
      <p class="range-field">
        <input type="range" min="10" max="100" id="size-slider" value="100" />
      </p>

      <h5>Output Format:</h5>
      <select class="browser-default">
        <!-- <option value="" disabled selected>Choose a format</option> -->
        <option value="1">.cbz (zip)</option>
      </select>

      <h5>
        Output Folder:
        <i
          class="fas fa-question-circle tooltipped blue-text accent-1-text"
          data-position="bottom"
          data-tooltip="If a file with the same name already exists in the folder, a subfix will be added to the converted file's name so nothing is overwritten"
        ></i>
      </h5>

      <div class="card">
        <div class="card-content" id="output-folder"></div>
        <a class="waves-effect waves-light btn" onclick="onChooseOutputFolder()"
          >CHANGE</a
        >
      </div>

      <a
        id="convert-button"
        class="btn modal-trigger blue-grey darken-3 disabled"
        onclick="onConvert()"
        data-target="modal1"
        >CONVERT</a
      >
    </div>

    <div id="modal1" class="modal">
      <div class="modal-content">
        <h5 id="modal-title">Converting File</h5>
        <p id="modal-info">...</p>
        <div class="progress" id="modal-loading-bar">
          <div class="indeterminate"></div>
        </div>
        <p id="modal-log"></p>
      </div>
      <div class="modal-footer" id="modal-button-container">
        <a
          href="#!"
          class="modal-close waves-effect waves-green btn-flat"
          id="modal-button-close"
          >Close</a
        >
      </div>
    </div>

    <script src="../assets/libs/materialize/js/materialize.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var elems = document.querySelectorAll(".modal");
        var instances = M.Modal.init(elems, {
          dismissible: false,
          onCloseStart: null,
        });

        elems = document.querySelectorAll(".tooltipped");
        instances = M.Tooltip.init(elems);
      });
    </script>
    <script>
      const path = require("path");
      const os = require("os");
      const { ipcRenderer } = require("electron");

      const FileDataType = {
        NOT_SET: "not set",
        PDF: "pdf",
        IMGS: "imgs",
        ZIP: "zip",
        RAR: "rar",
        EPUB: "epub",
      };

      let inputFilePath;
      let inputFileType;
      let outputSize = "100";
      let outputFormat = 1;
      let outputFolderPath;

      let inputListDiv = document.querySelector("#input-list");
      let outputFolderDiv = document.querySelector("#output-folder");
      let convertButton = document.querySelector("#convert-button");
      let sizeSlider = document.querySelector("#size-slider");
      let modalInfoArea = document.querySelector("#modal-info");
      let modalLogArea = document.querySelector("#modal-log");
      let modalButtonContainer = document.querySelector(
        "#modal-button-container"
      );
      let modalButtonClose = document.querySelector("#modal-button-close");
      let modalLoadingBar = document.querySelector("#modal-loading-bar");
      let modalTitle = document.querySelector("#modal-title");

      sizeSlider.addEventListener("mouseup", (event) => {
        outputSize = event.currentTarget.value;
        checkValidData();
      });
      // sizeSlider.addEventListener("input", (event) => {
      //   document.getElementById("toolbar-page-numbers").innerHTML =
      //     event.currentTarget.value + " / " + event.currentTarget.max;
      // });

      function checkValidData() {
        if (outputFolderPath !== undefined && inputFilePath !== undefined) {
          if (outputSize !== "100" || inputFileType !== FileDataType.ZIP) {
            convertButton.classList.remove("disabled");
            return;
          }
        }
        convertButton.classList.add("disabled");
      }

      function onChooseInputFile() {
        ipcRenderer.send("convert-choose-file");
      }

      function onChooseOutputFolder() {
        ipcRenderer.send("convert-choose-folder");
      }

      function reducePathString(input) {
        var length = 70;
        input =
          input.length > length
            ? "..." + input.substring(input.length - length, input.length)
            : input;
        return input;
      }

      ipcRenderer.on("add-file", (event, filePath, fileType) => {
        inputFilePath = filePath;
        inputFileType = fileType;
        inputListDiv.innerHTML =
          "<div class='card-content'>" +
          reducePathString(inputFilePath) +
          "</div>";

        outputFolderPath = path.dirname(filePath);
        outputFolderDiv.innerHTML = reducePathString(outputFolderPath);

        checkValidData();
      });

      ipcRenderer.on("change-output-folder", (event, folderPath) => {
        outputFolderPath = folderPath;
        outputFolderDiv.innerHTML = reducePathString(outputFolderPath);
        checkValidData();
      });

      ipcRenderer.on("convert-state-update", (event, updateType, data) => {
        switch (updateType) {
          case "text-info":
            modalInfoArea.innerHTML = data;
            break;

          case "text-log":
            modalLogArea.innerHTML = data;
            break;

          case "finished-ok":
            modalTitle.innerHTML = "New File Correctly Created:";
            modalInfoArea.innerHTML = data;
            modalButtonClose.classList.remove("hide");
            modalLoadingBar.classList.add("hide");
            modalLogArea.innerHTML = "";
            break;

          default:
            break;
        }
      });

      function onConvert() {
        // modalInfoArea.innerHTML = "file: " + inputFilePath;
        modalTitle.innerHTML = "Converting:";
        modalButtonClose.classList.add("hide");
        modalLoadingBar.classList.remove("hide");
        ipcRenderer.send(
          "convert-do-conversion",
          inputFilePath,
          inputFileType,
          outputSize,
          outputFormat,
          outputFolderPath
        );
      }
    </script>
  </body>
</html>
